<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Devang Hair Study</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: 'Prata' for headlines, 'Inter' for UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Prata&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Configuration ---
        const STALKER_THRESHOLD = 3; 
        const TIME_WINDOW = 2 * 60 * 1000;
        const STORAGE_KEY = 'devang_hair_events';

        // --- UI Elements ---
        const countEl = document.getElementById('count-display');
        const btn = document.getElementById('log-btn');
        const modal = document.getElementById('stalker-modal');
        const lastSeenEl = document.getElementById('last-seen-timer');
        let currentUser = null;

        // --- Auth & Sync ---
        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error(e); }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    setupListener();
                }
            });
        }

        function setupListener() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'devang_hair_log', 'clean_stats');
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    updateDisplay(data.count || 0);
                    updateLastSeen(data.lastTimestamp); // Hypothetical field, we can mock it locally for now if not in DB
                } else {
                    setDoc(docRef, { count: 0, lastTimestamp: Date.now() });
                    updateDisplay(0);
                }
            });
        }

        function updateDisplay(val) {
            countEl.style.transform = 'scale(1.1)';
            setTimeout(() => countEl.style.transform = 'scale(1)', 150);
            countEl.innerText = val.toLocaleString('en-US', { minimumIntegerDigits: 2 });
            
            // Reset local timer visual
            lastSeenEl.innerText = "Just now";
        }

        function updateLastSeen(timestamp) {
            // Simple mock logic for "Last seen" text if we don't have real DB timestamp
            // In a real app, we'd compare Date.now() with timestamp
        }

        // --- Stalker Logic ---
        function isStalking() {
            const now = Date.now();
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            history = history.filter(ts => now - ts < TIME_WINDOW);
            history.push(now);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));

            if (history.length > STALKER_THRESHOLD) {
                localStorage.setItem(STORAGE_KEY, '[]');
                return true;
            }
            return false;
        }

        // --- Actions ---
        async function handleLog() {
            if (!currentUser) return;

            // Feedback
            btn.classList.add('scale-90');
            setTimeout(() => btn.classList.remove('scale-90'), 100);

            if (isStalking()) {
                showModal();
            }

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'devang_hair_log', 'clean_stats');
            try {
                // We add a timestamp here so we could potentially track "time since last adjustment"
                await updateDoc(docRef, { 
                    count: increment(1),
                    lastTimestamp: Date.now() 
                });
            } catch (e) {
                await setDoc(docRef, { count: 1, lastTimestamp: Date.now() }, { merge: true });
            }
        }

        function showModal() {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        document.getElementById('modal-close').addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        btn.addEventListener('click', handleLog);
        init();
    </script>

    <style>
        body {
            background-color: #f3f3f3;
            color: #111;
            font-family: 'Inter', sans-serif;
        }

        .font-serif-title { font-family: 'Prata', serif; }

        /* Animation for counter update */
        #count-display {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }

        /* Button styling */
        .log-btn {
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }
        .log-btn:active {
            box-shadow: 0 5px 15px -5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="h-screen w-full flex items-center justify-center overflow-hidden bg-stone-100">

    <!-- Card Container: Fixed Size, No Scroll -->
    <main class="w-full max-w-md h-full bg-white relative flex flex-col p-6 sm:h-[90vh] sm:rounded-3xl sm:shadow-2xl sm:border sm:border-stone-200">
        
        <!-- Top Section: Title & Stats -->
        <div class="flex flex-col items-center justify-center mt-4 mb-2 flex-shrink-0">
            <h1 class="font-serif-title text-3xl text-center text-stone-900 leading-tight mb-4">
                I saw Devang setting his hair
            </h1>
            
            <div class="flex flex-col items-center">
                <div class="flex items-baseline gap-2">
                    <span id="count-display" class="text-8xl font-thin tracking-tighter text-black leading-none">
                        --
                    </span>
                    <span class="text-lg font-medium text-stone-400">times.</span>
                </div>
                <!-- Dynamic Satire Element -->
                <p class="text-xs text-stone-400 font-mono mt-2 uppercase tracking-widest">
                    Last incident: <span id="last-seen-timer" class="text-red-500 font-bold">Waiting...</span>
                </p>
            </div>
        </div>

        <!-- Middle Section: Video (Flex to fill) -->
        <div class="flex-1 w-full flex items-center justify-center py-4 min-h-0">
            <div class="relative w-full aspect-square max-h-full bg-black rounded-lg overflow-hidden shadow-lg border border-stone-100">
                <!-- 
                   USER INSTRUCTION: 
                   1. Add your .mov file to your project assets.
                   2. Replace src="" with src="./your-video-file.mov"
                -->
                <video 
                    class="w-full h-full object-cover" 
                    autoplay 
                    loop 
                    muted 
                    playsinline
                >
                    <source src="" type="video/quicktime"> <!-- Place .mov path here -->
                    <source src="" type="video/mp4">
                </video>

                <!-- "Live" Indicator Overlay -->
                <div class="absolute top-4 left-4 flex gap-2 items-center bg-black/50 backdrop-blur-sm px-3 py-1 rounded-full">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-[10px] text-white font-bold tracking-wider uppercase">Live Feed</span>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Action -->
        <div class="flex flex-col items-center justify-end mb-4 flex-shrink-0">
            <!-- Hint Arrow -->
            <div class="mb-4 animate-bounce text-stone-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
            </div>

            <!-- The Big Button -->
            <button id="log-btn" class="log-btn w-24 h-24 bg-black rounded-full flex items-center justify-center text-white text-4xl touch-manipulation">
                <span class="pb-1">+</span>
            </button>
            
            <div class="mt-6 text-[9px] text-stone-300 uppercase tracking-[0.3em] font-bold">
                Department of Vanity
            </div>
        </div>

    </main>

    <!-- Stalker Modal -->
    <div id="stalker-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-white/95 backdrop-blur-md p-6">
        <div class="w-full max-w-xs text-center p-6 border-2 border-black">
            <div class="text-6xl mb-4">üßê</div>
            <h3 class="font-serif-title text-2xl text-black mb-3">
                Looks like you're stalking Devang?
            </h3>
            <p class="text-xs font-mono text-stone-500 mb-6 leading-relaxed">
                EXCESSIVE LOGGING DETECTED. PLEASE MAINTAIN PROFESSIONAL DISTANCE FROM THE SUBJECT.
            </p>
            <button id="modal-close" class="w-full py-3 bg-black text-white text-xs font-bold uppercase tracking-widest hover:bg-stone-800 transition-colors">
                I Understand
            </button>
        </div>
    </div>

</body>
</html>


